/**
 * Constants for precomputed atmospheric scattering.
 *
 * ============================================================================
 * 논문 참조: "Precomputed Atmospheric Scattering"
 *           Eric Bruneton, Fabrice Neyret (2008)
 *           Eurographics Symposium on Rendering
 * ============================================================================
 *
 * 이 파일은 대기 산란 시뮬레이션에 필요한 물리 상수와 텍스처 크기를 정의합니다.
 *
 * 논문 Section 2.1 "Physical model"에서 설명하는 대기 모델:
 * - 대기는 Rg(지표면)부터 Rt(대기권 상단)까지의 얇은 구형 층
 * - 두 가지 구성요소: 공기 분자(Rayleigh)와 에어로졸 입자(Mie)
 * - 밀도는 고도에 따라 지수 함수적으로 감소
 */

#ifndef AtmosphereConstants_h
#define AtmosphereConstants_h

// =============================================================================
// 사전 계산 텍스처 크기 (논문 Section 4 "Precomputations")
// =============================================================================

/**
 * Transmittance(투과율) 텍스처
 *
 * 논문 Equation 5:
 *   T(x, x_o) = exp(-∫[x to x_o] Σ β_i^e(y) dy)
 *
 * 투과율은 점 x에서 대기권 경계 x_o까지 빛이 얼마나 감쇠하는지를 나타냅니다.
 * 구의 대칭성으로 인해 2개의 파라미터로 축소 가능:
 *   - r: 행성 중심으로부터의 거리 (고도)
 *   - μ(mu): 시선 천정각의 코사인 값 (view zenith angle)
 *
 * 논문 Section 4: "We precompute T(x, x̄_o(x,v)) for all x,v in a 2D table T(x,v)."
 */
#define TRANSMITTANCE_TEXTURE_WIDTH  256  // μ 방향 샘플 수
#define TRANSMITTANCE_TEXTURE_HEIGHT 64   // r 방향 샘플 수

/**
 * Scattering(산란) 텍스처 크기
 *
 * 논문 Section 4: 4D 테이블 S(u_r, u_μ, u_μs, u_ν)
 *
 * 4개의 파라미터:
 *   - r: 고도 (altitude) - R_SIZE 샘플
 *   - μ(mu): 시선 천정각 코사인 - MU_SIZE 샘플
 *   - μ_s(mu_s): 태양 천정각 코사인 - MU_S_SIZE 샘플
 *   - ν(nu): 시선-태양 각도 코사인 - NU_SIZE 샘플
 *
 * 논문 Figure 3-4: μ 파라미터화에서 수평선 근처의 정밀도 문제를 해결하기 위해
 * 특별한 비선형 매핑 u_μ를 사용합니다. 이는 aerial perspective(공중 원근법)의
 * 정확한 계산에 필수적입니다.
 */
#define SCATTERING_TEXTURE_R_SIZE    32   // 고도 샘플 수
#define SCATTERING_TEXTURE_MU_SIZE   128  // 시선 천정각 샘플 수 (수평선 정밀도를 위해 높음)
#define SCATTERING_TEXTURE_MU_S_SIZE 32   // 태양 천정각 샘플 수
#define SCATTERING_TEXTURE_NU_SIZE   8    // 시선-태양 각도 샘플 수

/**
 * 3D 텍스처로 패킹된 4D 산란 테이블
 *
 * 논문 Section 6: "We store S(u_r, u_μ, u_μs, u_ν) in a 32×128×32×8 table,
 * seen as 8 3D tables packed in a single 32×128×256 RGBA texture"
 *
 * 4D → 3D 변환: ν 차원을 Width에 병합
 *   Width = NU_SIZE × MU_S_SIZE = 8 × 32 = 256
 *   Height = MU_SIZE = 128
 *   Depth = R_SIZE = 32
 */
#define SCATTERING_TEXTURE_WIDTH  (SCATTERING_TEXTURE_NU_SIZE * SCATTERING_TEXTURE_MU_S_SIZE)
#define SCATTERING_TEXTURE_HEIGHT SCATTERING_TEXTURE_MU_SIZE
#define SCATTERING_TEXTURE_DEPTH  SCATTERING_TEXTURE_R_SIZE

/**
 * Irradiance(복사 조도) 텍스처
 *
 * 논문 Equation 15:
 *   Ē[L̄*](x_o, s) = ∫[2π] L̄*(x_o, ω, s) ω·n̄(x_o) dω
 *
 * 지표면에서 받는 하늘광(sky irradiance)을 저장합니다.
 * 2개의 파라미터:
 *   - r: 고도 (지표면에서는 bottom_radius)
 *   - μ_s: 태양 천정각 코사인
 */
#define IRRADIANCE_TEXTURE_WIDTH  64   // μ_s 방향 샘플 수
#define IRRADIANCE_TEXTURE_HEIGHT 16   // r 방향 샘플 수

// =============================================================================
// 물리 상수
// =============================================================================

/**
 * 최대 광효율 (Maximum Luminous Efficacy)
 *
 * 555nm(녹색광)에서의 인간 눈의 광효율.
 * Radiance → Luminance 변환에 사용됩니다.
 */
#define MAX_LUMINOUS_EFFICACY 683.0  // lm/W

/**
 * 원주율
 *
 * 논문 전체에서 사용되는 기하학적 계산에 필요합니다.
 * Phase function, solid angle 적분 등에 사용.
 */
#define PI 3.14159265358979323846

/**
 * RGB 채널 파장 (나노미터)
 *
 * 논문 Section 2.1: Rayleigh 산란 계수는 파장에 의존합니다.
 *   β_R^s ∝ 1/λ^4 (Equation 1)
 *
 * 짧은 파장(파란색)이 더 강하게 산란되어 낮 하늘이 파랗게 보입니다.
 */
#define LAMBDA_R 680.0  // 빨간색 (nm)
#define LAMBDA_G 550.0  // 녹색 (nm)
#define LAMBDA_B 440.0  // 파란색 (nm)

// =============================================================================
// 지구 대기 기본 파라미터 (논문 Section 2.1 "Physical model")
// =============================================================================

/**
 * 지구 반경 (미터)
 *
 * 논문: "a thin spherical layer of decreasing density between Rg = 6360 km
 *        and Rt = 6420 km"
 *
 * - BOTTOM_RADIUS (Rg): 지표면 반경, 대기의 하한
 * - TOP_RADIUS (Rt): 대기권 상단 반경, 대기의 상한
 *
 * 대기층 두께: 60km (우주에서 보면 매우 얇은 층)
 */
#define EARTH_BOTTOM_RADIUS 6360000.0  // Rg = 6360 km (미터 단위)
#define EARTH_TOP_RADIUS    6420000.0  // Rt = 6420 km (미터 단위)

/**
 * Rayleigh 스케일 높이 (H_R)
 *
 * 논문 Equation 1:
 *   β_R^s(h, λ) = (8π³(n²-1)²)/(3Nλ⁴) × exp(-h/H_R)
 *
 * H_R = 8 km: 대기 밀도가 균일하다고 가정했을 때의 등가 두께
 * 이 높이에서 Rayleigh 산란 계수가 해수면 값의 1/e (약 37%)로 감소
 */
#define RAYLEIGH_SCALE_HEIGHT 8000.0  // H_R = 8 km (미터 단위)

/**
 * Mie 스케일 높이 (H_M)
 *
 * 논문 Equation 3:
 *   β_M^s(h, λ) = β_M^s(0, λ) × exp(-h/H_M)
 *
 * H_M ≈ 1.2 km: 에어로졸은 공기 분자보다 훨씬 낮은 고도에 집중
 * 이는 지표면 근처의 연무(haze)를 설명합니다.
 */
#define MIE_SCALE_HEIGHT 1200.0  // H_M ≈ 1.2 km (미터 단위)

/**
 * Mie 위상 함수 비대칭 파라미터 (g)
 *
 * 논문 Equation 4 (Cornette-Shanks phase function):
 *   P_M(μ) = (3/8π) × (1-g²)(1+μ²) / [(2+g²)(1+g²-2gμ)^(3/2)]
 *
 * g ∈ [-1, 1]:
 *   - g > 0: 전방 산란 우세 (빛이 원래 방향으로 계속 진행하려는 경향)
 *   - g = 0: 등방성 산란
 *   - g < 0: 후방 산란 우세
 *
 * g = 0.8: 에어로졸의 강한 전방 산란을 모델링
 * 이는 태양 주변의 밝은 후광(corona/aureole) 효과를 만듭니다.
 */
#define MIE_PHASE_FUNCTION_G 0.8

/**
 * 오존층 파라미터
 *
 * 오존은 자외선을 흡수하고 일부 가시광선도 흡수합니다.
 * 흡수 프로파일은 고도에 따른 밀도 분포로 모델링됩니다.
 *
 * 오존층 중심: 약 25km 고도
 * 오존층 폭: 약 15km (반폭 기준)
 */
#define OZONE_LAYER_CENTER_ALTITUDE 25000.0  // 25 km (미터 단위)
#define OZONE_LAYER_WIDTH 15000.0            // 15 km (미터 단위)

// =============================================================================
// CIE 1931 2도 색매칭 함수
// (파장 360nm ~ 830nm, 5nm 간격)
//
// Radiance(분광 방사휘도)를 XYZ 색공간으로 변환하는 데 사용됩니다.
// 각 행: [파장(nm), x̄, ȳ, z̄]
// =============================================================================

#ifdef __cplusplus
namespace atmosphere {
#endif

// CPU 전용 데이터 (Metal 셰이더에서는 사용 불가)
#ifndef __METAL_VERSION__

static const double CIE_2_DEG_COLOR_MATCHING_FUNCTIONS[380] = {
    360, 0.000129900000, 0.000003917000, 0.000606100000,
    365, 0.000232100000, 0.000006965000, 0.001086000000,
    370, 0.000414900000, 0.000012390000, 0.001946000000,
    375, 0.000741600000, 0.000022020000, 0.003486000000,
    380, 0.001368000000, 0.000039000000, 0.006450001000,
    385, 0.002236000000, 0.000064000000, 0.010549990000,
    390, 0.004243000000, 0.000120000000, 0.020050010000,
    395, 0.007650000000, 0.000217000000, 0.036210000000,
    400, 0.014310000000, 0.000396000000, 0.067850010000,
    405, 0.023190000000, 0.000640000000, 0.110200000000,
    410, 0.043510000000, 0.001210000000, 0.207400000000,
    415, 0.077630000000, 0.002180000000, 0.371300000000,
    420, 0.134380000000, 0.004000000000, 0.645600000000,
    425, 0.214770000000, 0.007300000000, 1.039050100000,
    430, 0.283900000000, 0.011600000000, 1.385600000000,
    435, 0.328500000000, 0.016840000000, 1.622960000000,
    440, 0.348280000000, 0.023000000000, 1.747060000000,
    445, 0.348060000000, 0.029800000000, 1.782600000000,
    450, 0.336200000000, 0.038000000000, 1.772110000000,
    455, 0.318700000000, 0.048000000000, 1.744100000000,
    460, 0.290800000000, 0.060000000000, 1.669200000000,
    465, 0.251100000000, 0.073900000000, 1.528100000000,
    470, 0.195360000000, 0.090980000000, 1.287640000000,
    475, 0.142100000000, 0.112600000000, 1.041900000000,
    480, 0.095640000000, 0.139020000000, 0.812950100000,
    485, 0.057950010000, 0.169300000000, 0.616200000000,
    490, 0.032010000000, 0.208020000000, 0.465180000000,
    495, 0.014700000000, 0.258600000000, 0.353300000000,
    500, 0.004900000000, 0.323000000000, 0.272000000000,
    505, 0.002400000000, 0.407300000000, 0.212300000000,
    510, 0.009300000000, 0.503000000000, 0.158200000000,
    515, 0.029100000000, 0.608200000000, 0.111700000000,
    520, 0.063270000000, 0.710000000000, 0.078249990000,
    525, 0.109600000000, 0.793200000000, 0.057250010000,
    530, 0.165500000000, 0.862000000000, 0.042160000000,
    535, 0.225749900000, 0.914850100000, 0.029840000000,
    540, 0.290400000000, 0.954000000000, 0.020300000000,
    545, 0.359700000000, 0.980300000000, 0.013400000000,
    550, 0.433449900000, 0.994950100000, 0.008749999000,
    555, 0.512050100000, 1.000000000000, 0.005749999000,
    560, 0.594500000000, 0.995000000000, 0.003900000000,
    565, 0.678400000000, 0.978600000000, 0.002749999000,
    570, 0.762100000000, 0.952000000000, 0.002100000000,
    575, 0.842500000000, 0.915400000000, 0.001800000000,
    580, 0.916300000000, 0.870000000000, 0.001650001000,
    585, 0.978600000000, 0.816300000000, 0.001400000000,
    590, 1.026300000000, 0.757000000000, 0.001100000000,
    595, 1.056700000000, 0.694900000000, 0.001000000000,
    600, 1.062200000000, 0.631000000000, 0.000800000000,
    605, 1.045600000000, 0.566800000000, 0.000600000000,
    610, 1.002600000000, 0.503000000000, 0.000340000000,
    615, 0.938400000000, 0.441200000000, 0.000240000000,
    620, 0.854449900000, 0.381000000000, 0.000190000000,
    625, 0.751400000000, 0.321000000000, 0.000100000000,
    630, 0.642400000000, 0.265000000000, 0.000049999990,
    635, 0.541900000000, 0.217000000000, 0.000030000000,
    640, 0.447900000000, 0.175000000000, 0.000020000000,
    645, 0.360800000000, 0.138200000000, 0.000010000000,
    650, 0.283500000000, 0.107000000000, 0.000000000000,
    655, 0.218700000000, 0.081600000000, 0.000000000000,
    660, 0.164900000000, 0.061000000000, 0.000000000000,
    665, 0.121200000000, 0.044580000000, 0.000000000000,
    670, 0.087400000000, 0.032000000000, 0.000000000000,
    675, 0.063600000000, 0.023200000000, 0.000000000000,
    680, 0.046770000000, 0.017000000000, 0.000000000000,
    685, 0.032900000000, 0.011920000000, 0.000000000000,
    690, 0.022700000000, 0.008210000000, 0.000000000000,
    695, 0.015840000000, 0.005723000000, 0.000000000000,
    700, 0.011359160000, 0.004102000000, 0.000000000000,
    705, 0.008110916000, 0.002929000000, 0.000000000000,
    710, 0.005790346000, 0.002091000000, 0.000000000000,
    715, 0.004109457000, 0.001484000000, 0.000000000000,
    720, 0.002899327000, 0.001047000000, 0.000000000000,
    725, 0.002049190000, 0.000740000000, 0.000000000000,
    730, 0.001439971000, 0.000520000000, 0.000000000000,
    735, 0.000999949300, 0.000361100000, 0.000000000000,
    740, 0.000690078600, 0.000249200000, 0.000000000000,
    745, 0.000476021300, 0.000171900000, 0.000000000000,
    750, 0.000332301100, 0.000120000000, 0.000000000000,
    755, 0.000234826100, 0.000084800000, 0.000000000000,
    760, 0.000166150500, 0.000060000000, 0.000000000000,
    765, 0.000117413000, 0.000042400000, 0.000000000000,
    770, 0.000083075270, 0.000030000000, 0.000000000000,
    775, 0.000058706520, 0.000021200000, 0.000000000000,
    780, 0.000041509940, 0.000014990000, 0.000000000000,
    785, 0.000029353260, 0.000010600000, 0.000000000000,
    790, 0.000020673830, 0.000007465700, 0.000000000000,
    795, 0.000014559770, 0.000005257800, 0.000000000000,
    800, 0.000010253980, 0.000003702900, 0.000000000000,
    805, 0.000007221456, 0.000002607800, 0.000000000000,
    810, 0.000005085868, 0.000001836600, 0.000000000000,
    815, 0.000003581652, 0.000001293400, 0.000000000000,
    820, 0.000002522525, 0.000000910930, 0.000000000000,
    825, 0.000001776509, 0.000000641530, 0.000000000000,
    830, 0.000001251141, 0.000000451810, 0.000000000000,
};

// =============================================================================
// XYZ → sRGB 변환 행렬
// 행 우선 순서: sRGB = XYZ_TO_SRGB × XYZ
// =============================================================================

static const double XYZ_TO_SRGB[9] = {
    +3.2406, -1.5372, -0.4986,
    -0.9689, +1.8758, +0.0415,
    +0.0557, -0.2040, +1.0570
};

#endif // __METAL_VERSION__ (CPU-only data)

// =============================================================================
// Metal 셰이더용 단위 정의
//
// 물리량의 차원 분석을 위한 단위 상수들입니다.
// 실제로는 모두 1.0이지만, 코드의 가독성과 차원 확인을 위해 사용합니다.
// =============================================================================

#ifdef __METAL_VERSION__

// 기본 단위 (SI 단위계 기반)
constant float m = 1.0;      // 미터 (길이)
constant float nm = 1.0;     // 나노미터 (파장)
constant float rad = 1.0;    // 라디안 (각도)
constant float sr = 1.0;     // 스테라디안 (입체각)
constant float watt = 1.0;   // 와트 (전력/에너지 플럭스)
constant float lm = 1.0;     // 루멘 (광속)

// 파생 단위
constant float km = 1000.0 * m;                                    // 킬로미터
constant float m2 = m * m;                                         // 제곱미터 (면적)
constant float m3 = m * m * m;                                     // 세제곱미터 (부피)
constant float pi = PI * rad;                                      // π 라디안
constant float deg = pi / 180.0;                                   // 도(degree) → 라디안

// 방사량 단위
constant float watt_per_square_meter = watt / m2;                  // W/m² (Irradiance)
constant float watt_per_square_meter_per_sr = watt / (m2 * sr);    // W/(m²·sr) (Radiance)
constant float watt_per_square_meter_per_nm = watt / (m2 * nm);    // W/(m²·nm) (Spectral Irradiance)
constant float watt_per_square_meter_per_sr_per_nm = watt / (m2 * sr * nm);  // W/(m²·sr·nm) (Spectral Radiance)
constant float watt_per_cubic_meter_per_sr_per_nm = watt / (m3 * sr * nm);   // Volume scattering coefficient

// 광도량 단위
constant float cd = lm / sr;                                       // 칸델라 (광도)
constant float kcd = 1000.0 * cd;                                  // 킬로칸델라
constant float cd_per_square_meter = cd / m2;                      // cd/m² (휘도, Luminance)
constant float kcd_per_square_meter = kcd / m2;                    // kcd/m²

#endif // __METAL_VERSION__

#ifdef __cplusplus
} // namespace atmosphere
#endif

#endif /* AtmosphereConstants_h */
